<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Account</title>
    <%- include partials/head.ejs %>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    
    <div> Connecting as client </div>
    <%- include partials/scripts.ejs %>
    <script>
      let socket = io({transports: ['websocket']}); // Use auto-discovery

      socket.emit("client_connect", {
        powerState: {},
        totalMem: 8
      });

      socket.on("connect", () => {
        console.log("Connected");
      })

      socket.on("scrape", (data) => {
        console.log(`Scraping url ${data.url}`);

        // Send request through CORS proxy first to avoid access error
        const proxyurl = "https://cors-anywhere.herokuapp.com/";
        const url = "https://" + data.url;

        fetch(proxyurl + data.url) // https://cors-anywhere.herokuapp.com/https://example.com
        .then(response => response.text())
        .then(contents => {
          console.log("Returning result to user");
          socket.emit("return_result", {
            result: contents,
            user_id: data.user_id,
            powerState: {},
            totalMem: 8
          })
        })
        .catch(() => {
          let error = "Canâ€™t access " + url + " response. Blocked by browser?"
          socket.emit("return_result", {
            result: error,
            user_id: data.user_id,
            powerState: {},
            totalMem: 0
          })
        })
      });
    </script>
  </body>
</html>
